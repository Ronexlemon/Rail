# -----------------------
# VARIABLES
# -----------------------
GO := go
# Path to the Go file for Kafka topic registration
TOPIC_CMD := ./shared/kafka/topics/cmd/register.go
# Prisma client command (assuming this is the path/module used to invoke prisma commands)
PRISMA_CMD := github.com/steebchen/prisma-client-go
PRISMA_GENERATE_CMD := github.com/steebchen/prisma-client-go 
PROTO_DIR := ./proto
PROTO_OUT := ./proto

# -----------------------
# TARGETS
# -----------------------

# Default target runs all setup steps: topics, dbpush, dbgenerate
.PHONY: all
all: topics dbpush dbgenerate protos

# Run the Kafka topic creation script
.PHONY: topics
topics:
	@echo "ðŸš€ Creating Kafka topics..."
	@$(GO) run $(TOPIC_CMD)
	@echo "âœ… Kafka topics successfully created!"

# Run Prisma DB push (migrates schema to the database)
.PHONY: dbpush
dbpush:
	@echo "ðŸš€ Running Prisma DB push..."
	@$(GO) run $(PRISMA_CMD) db push
	@echo "âœ… Prisma DB push complete!"

# Run Prisma DB generate (generates the Go client based on the schema)
.PHONY: dbgenerate
dbgenerate:
	@echo "ðŸš€ Running Prisma DB generate..."
	@$(GO) run $(PRISMA_GENERATE_CMD) generate
	@echo "âœ… Prisma DB generate complete!"

.PHONY: protos
protos:
	@echo "ðŸš€ Compiling gRPC proto files..."
	protoc --go_out=$(PROTO_OUT) --go-grpc_out=$(PROTO_OUT) $(PROTO_DIR)/*.proto
	@echo "âœ… Proto compilation complete!"

# Clean build cache (optional)
.PHONY: clean
clean:
	@echo "ðŸ§¹ Cleaning Go build cache..."
	@$(GO) clean -cache -modcache
	@echo "âœ… Clean complete!"