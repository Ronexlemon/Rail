# -----------------------
# VARIABLES. solc --abi erc20.sol -o .
#abigen --abi=IERC20.abi --pkg=token --out=erc20.go
# -----------------------
GO := go
TOPIC_CMD := ./shared/kafka/topics/cmd/register.go
PRISMA_CMD := github.com/steebchen/prisma-client-go
PRISMA_GENERATE_CMD := github.com/steebchen/prisma-client-go

PROTO_DIR := ./proto
PROTO_OUT := ./proto


SOLC := solc
ABIGEN := abigen
ABI_DIR := ./utils/helpers/tokens/abi   # folder containing the contract
SOL_CONTRACT := $(ABI_DIR)/erc20.sol
ABI_OUT := $(ABI_DIR)/IERC20.abi
GO_OUT := $(ABI_DIR)/erc20.go
PKG := token



# -----------------------
# TARGETS
# -----------------------

.PHONY: all
all: topics dbpush dbgenerate protos contract

.PHONY: topics
topics:
	@echo "ðŸš€ Creating Kafka topics..."
	@$(GO) run $(TOPIC_CMD)
	@echo "âœ… Kafka topics successfully created!"

.PHONY: dbpush
dbpush:
	@echo "ðŸš€ Running Prisma DB push..."
	@$(GO) run $(PRISMA_CMD) db push
	@echo "âœ… Prisma DB push complete!"

.PHONY: dbgenerate
dbgenerate:
	@echo "ðŸš€ Running Prisma DB generate..."
	@$(GO) run $(PRISMA_GENERATE_CMD) generate
	@echo "âœ… Prisma DB generate complete!"

.PHONY: protos
protos:
	@echo "ðŸš€ Compiling gRPC proto files..."
	protoc \
		--go_out=. --go_opt=paths=source_relative \
		--go-grpc_out=. --go-grpc_opt=paths=source_relative \
		$(PROTO_DIR)/*.proto
	@echo "âœ… Proto compilation complete!"


.PHONY: contract
contract:
	@echo "ðŸš€ Compiling Solidity contract and generating Go bindings..."
	$(SOLC) --abi ./utils/helpers/tokens/abi/erc20.sol -o ./utils/helpers/tokens/abi
	$(ABIGEN) --abi= ./utils/helpers/tokens/abi/IERC20.abi --pkg=token --out=erc20.go
	@echo "âœ… Contract Go bindings generated!"
	
.PHONY: clean
clean:
	@echo "ðŸ§¹ Cleaning Go build cache..."
	@$(GO) clean -cache -modcache
	@echo "âœ… Clean complete!"
